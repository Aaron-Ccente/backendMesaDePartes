<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <style>
        /* CONFIGURACIÓN A4 ROBUSTA */
        @page {
            size: A4;
            margin: 15mm 25mm 20mm 25mm; /* Márgenes físicos para impresión */
        }
        
        body { 
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 9.5pt;
            line-height: 1.4;
            color: black;
            margin: 0;
            padding: 0; 
            width: 100%;
            box-sizing: border-box;
            /* Prevención de desbordamientos global */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Si estamos en el iframe de vista previa, simulamos el padding que Puppeteer inyecta via @page */
        .page-content {
             padding: 15mm 25mm 20mm 25mm; /* Solo visual en navegador/iframe */
             width: 210mm; /* Forzar ancho A4 */
             min-height: 297mm;
             box-sizing: border-box;
             background: white;
        }
        /* En modo impresión (PDF Puppeteer), quitamos ese padding simulado porque @page lo pone */
        @media print {
            .page-content {
                padding: 0;
                width: 100%;
            }
        }

        /* Estilos del Membrete (Incrustados para garantizar renderizado) */
        .membrete-container {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-bottom: 8px;
            height: 52px;
            overflow: hidden; /* Evitar expansión vertical */
        }
        .membrete-escudo {
            width: 45px;
            height: 100%;
            object-fit: contain;
        }
        .membrete-bloque {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            font-size: 7pt;
            line-height: 1.1;
            padding: 2px;
            box-sizing: border-box;
            font-weight: bold;
            overflow: hidden; /* Cortar texto si es muy largo en bloques pequeños */
        }
        .bloque-peru { background-color: #D32F2F; width: 64px; min-width: 64px; }
        .bloque-ministerio { background-color: #424242; width: 94px; min-width: 94px; }
        .bloque-policia { background-color: #616161; width: 94px; min-width: 94px; }
        .bloque-comando { background-color: #757575; width: 110px; min-width: 110px; }
        .bloque-direccion { background-color: #9E9E9E; width: 110px; min-width: 110px; }
        .bloque-region { background-color: #BDBDBD; width: 83px; min-width: 83px; }

        .lema {
            text-align: center;
            font-size: 9pt;
            font-style: italic;
            margin: 5px 0 10px 0;
            white-space: nowrap; /* Evitar saltos de línea feos en lemas cortos */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .linea-horizontal {
            border-top: 1.5px solid #000;
            margin-bottom: 5px;
        }

        /* Cuerpo del Informe */
        .titulo-informe {
            text-align: center;
            margin-bottom: 10px;
        }
        .titulo-principal {
            font-weight: bold;
            text-decoration: underline;
            font-size: 12pt;
            display: block;
        }
        .subtitulo-numero {
            font-weight: bold;
            font-size: 11pt;
            display: block;
        }

        .fila {
            display: flex;
            margin-top: 5px;
            align-items: baseline;
        }
        .label-letra {
            min-width: 8mm;
            font-weight: bold;
        }
        .label-campo {
            min-width: 50mm;
            font-weight: bold;
        }
        .label-campo-largo {
            min-width: 52mm;
            font-weight: bold;
        }
        .valor-campo {
            flex: 1;
            text-align: justify;
            word-break: break-word; /* Clave para evitar desbordamiento horizontal */
        }

        .indentado {
            margin-left: 12mm;
            margin-top: 3px;
            text-align: justify;
            word-break: break-word;
        }

        .tabla-resultados {
            width: 100%;
            border-collapse: collapse;
            margin-left: 8mm;
            margin-top: 5px;
            table-layout: fixed; /* Fuerza a respetar anchos */
        }
        .tabla-resultados td {
            padding: 1px 0;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .col-analito {
            width: 65mm;
            padding-right: 5mm; /* Espacio visual entre columnas */
        }

        .separador-dashed {
            border-top: 1px dashed #000;
            margin: 5px 0;
        }

        .fecha-lugar {
            text-align: right;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .firma-container {
            width: 40%;
            margin-left: 60%; /* Alineado a la derecha */
            text-align: center;
            line-height: 1.2;
            page-break-inside: avoid; /* Intentar no partir firma en dos páginas */
        }
        .firma-linea {
            border-top: 1px solid #000;
            width: 100%;
            margin: 0 auto 5px auto;
        }
        .firma-nombre { font-weight: bold; margin: 0; }
        .firma-texto { margin: 0; font-size: 9pt; }

    </style>
</head>
<body>
    <div class="page-content">
        
        <!-- MEMBRETE -->
        <div class="membrete-container">
            <img src="{{imagenes.escudoUrl}}" alt="Escudo" class="membrete-escudo">
            <div class="membrete-bloque bloque-peru">PERÚ</div>
            <div class="membrete-bloque bloque-ministerio">Ministerio<br>del Interior</div>
            <div class="membrete-bloque bloque-policia">Policía Nacional<br>del Perú</div>
            <div class="membrete-bloque bloque-comando">{{config.MEMBRETE_COMANDO}}</div>
            <div class="membrete-bloque bloque-direccion">{{config.MEMBRETE_DIRECCION}}</div>
            <div class="membrete-bloque bloque-region">{{config.MEMBRETE_REGION}}</div>
        </div>

        <div class="linea-horizontal"></div>
        <div class="lema">"{{config.ANIO_LEMA}}"</div>

        <!-- TÍTULO -->
        <div class="titulo-informe">
            <span class="titulo-principal">INFORME PERICIAL CONSOLIDADO</span>
            <span class="subtitulo-numero">N° {{oficio.numero_oficio}}-{{oficio.anio_actual}}-{{oficio.sufijo_numero_oficio}}</span>
        </div>

        <!-- SECCIONES -->
        <div class="fila">
            <span class="label-letra">A.</span><span class="label-campo">PROCEDENCIA:</span>
            <span class="valor-campo">{{oficio.unidad_solicitante}}</span>
        </div>

        <div class="fila">
            <span class="label-letra">B.</span><span class="label-campo">ANTECEDENTE:</span>
            <span class="valor-campo">OF. {{oficio.documento_referencia}} ({{oficio.fecha_oficio_formateada}}).</span>
        </div>

        <div class="fila">
            <span class="label-letra">C.</span><span class="label-campo">PERITO:</span>
            <span class="valor-campo">{{perito.grado}} {{perito.nombre_completo}}, CIP: {{perito.cip}}, DNI: {{perito.dni_perito}}, C.Q.F.P N°{{perito.cqfp}}.</span>
        </div>

        <div class="fila">
            <span class="label-letra">D.</span><span class="label-campo">OBJETO DE LA PERICIA:</span>
            <span class="valor-campo">{{informe.objeto_pericia}}</span>
        </div>

        <div class="fila">
            <span class="label-letra">E.</span><span class="label-campo-largo">HORA DEL INCIDENTE</span><span>:</span>
            <span class="valor-campo">
                <span style="margin-right: 15px;">{{oficio.hora_incidente}}</span>
                <strong>FECHA:</strong> {{oficio.fecha_incidente_formateada}}
            </span>
        </div>

        <div class="fila">
            <span class="label-letra">F.</span><span class="label-campo-largo">HORA TOMA MUESTRA</span><span>:</span>
            <span class="valor-campo">
                <span style="margin-right: 15px;">{{oficio.hora_toma_muestra}}</span>
                <strong>FECHA:</strong> {{oficio.fecha_toma_muestra_formateada}}
            </span>
        </div>

        <div class="fila">
            <span class="label-letra">G.</span><span class="label-campo-largo">CONDUCTOR</span><span>:</span>
            <span class="valor-campo">{{oficio.conductor}}</span>
        </div>

        <div class="fila">
            <span class="label-letra">H.</span><span class="label-campo-largo">MUESTRA TOMADA A</span><span>:</span>
            <span class="valor-campo">{{oficio.examinado_incriminado}} ({{oficio.edad_examinado}}).</span>
        </div>

        <!-- MUESTRAS -->
        <div class="fila">
            <span class="label-letra">I.</span><span class="label-campo">MUESTRAS:</span>
        </div>
        {{#each informe.muestras}}
        <div class="indentado">
            <strong>{{this.codigo}}:</strong> {{this.descripcion_completa}}
        </div>
        {{/each}}

        <!-- EXAMEN -->
        <div class="fila">
            <span class="label-letra">J.</span><span class="label-campo">EXAMEN:</span>
        </div>
        <div class="indentado">
            {{#each informe.examenes}}
                <div style="margin-bottom: 5px;">
                    <strong style="text-decoration: underline;">{{this.nombre}}</strong>
                    <table class="tabla-resultados">
                        {{#each this.resultados}}
                        <tr>
                            <td class="col-analito">{{{this.analito}}}</td>
                            <td><strong>{{{this.resultado}}}</strong></td>
                        </tr>
                        {{/each}}
                    </table>
                </div>
            {{/each}}
        </div>

        <!-- CONCLUSIONES -->
        <div class="fila">
            <span class="label-letra">K.</span><span class="label-campo">CONCLUSIONES:</span>
        </div>
        <div class="indentado">
            <div style="display: flex;">
                <span style="margin-right: 5px;">1.</span>
                <span style="flex: 1;">{{informe.conclusion_principal}}</span>
            </div>
            
            {{#each informe.conclusiones_secundarias}}
                <div class="separador-dashed"></div>
                <div style="display: flex;">
                    <span style="margin-right: 5px;">{{inc @index 2}}.</span>
                    <span style="flex: 1;">{{this}}</span>
                </div>
            {{/each}}
            <div class="separador-dashed"></div>
        </div>

        <div class="fila">
            <span class="label-letra">L.</span><span class="label-campo">MUESTRA TOMADA POR:</span>
            <span class="valor-campo">{{informe.recolector_muestra}}.</span>
        </div>
        <div class="separador-dashed"></div>

        <!-- METODOS -->
        <div class="fila">
            <span class="label-letra">M.</span><span class="label-campo">METODO UTILIZADO:</span>
        </div>
        <div class="indentado">
            {{#each informe.metodos}}
                <div style="display: flex;">
                    <strong style="min-width: 30mm;">{{this.examen}}</strong>
                    <span>: {{this.metodo}}</span>
                </div>
            {{/each}}
        </div>

        <!-- FECHA -->
        <div class="fecha-lugar">
            {{formatLongDate oficio.fecha_creacion}}
        </div>

        <!-- FIRMA -->
        <div class="firma-container">
            <div class="firma-linea"></div>
            <p class="firma-nombre">{{perito.nombre_completo}}</p>
            <p class="firma-texto">{{perito.grado}}</p>
            <p class="firma-texto">{{perito.titulo_profesional}}</p>
        </div>

    </div>
</body>
</html>